---
title: Experimenting Around the Packages Table
author:
  - MaÃ«lle Salmon
date: '2020-04-30'
slug: table
categories: []
tags: []
package_version: 0.1.0
description: A very short summary of your post (~ 100 characters)
twitterImg: blog/2019/06/04/post-template/name-of-image.png
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
# Options to have images saved in the post folder
# And to disable symbols before output
knitr::opts_chunk$set(fig.path = "", comment = "")

# knitr hook to make images output use Hugo options
knitr::knit_hooks$set(
  plot = function(x, options) {
    hugoopts <- options$hugoopts
    paste0(
      "{{<figure src=",
      '"', x, '" ',
      if (!is.null(hugoopts)) {
        glue::glue_collapse(
          glue::glue('{names(hugoopts)}="{hugoopts}"'),
          sep = " "
        )
      },
      ">}}\n"
    )
  }
)

# knitr hook to use Hugo highlighting options
knitr::knit_hooks$set(
  source = function(x, options) {
  hlopts <- options$hlopts
    paste0(
      "```r ",
      if (!is.null(hlopts)) {
      paste0("{",
        glue::glue_collapse(
          glue::glue('{names(hlopts)}={hlopts}'),
          sep = ","
        ), "}"
        )
      },
      "\n", glue::glue_collapse(x, sep = "\n"), "\n```\n"
    )
  }
)
```


```{r table, echo=FALSE, message=FALSE}

cran_unquote <- function(string) {
  gsub("\\'(.*?)\\'", "\\1", string)
}

get_name <- function(list) {
  list$package[[1]]
}

get_description <- function(list) {
  cran_unquote(
    trimws(
    toString(
      list$details$description
      )
  )
  )
}

get_data_source <- function(list) {
  source <- 
      cran_unquote(
          trimws(
            toString(
              list$details$data_source
              )
    )
  )
  
  if (source == "NA"){
    return("")
  }
  
  return(source)
}

packages_json <- jsonlite::read_json("temp.json")

packages <- tibble::tibble(
  package = purrr::map_chr(packages_json, get_name),
  data_desc = purrr::map_chr(packages_json, get_description),
  data_source = purrr::map_chr(packages_json, get_data_source)
  )


citations <- readr::read_tsv("citations_all.tsv")
citations <- citations[!is.na(citations$doi),]
citations$citation <- gsub("https://doi\\.org.*", "", citations$citation)
citations$citation <- gsub("http://doi\\.org.*", "", citations$citation)
citations$citation <- gsub("doi.*", "", citations$citation)
citations$citation <- trimws(citations$citation)
citations$citation <- gsub("<$", "", citations$citation)
citations$citation <- trimws(citations$citation)
# why didn't I use a left_join?!
get_citations <- function(package, citations) {
  if (!any(citations$name == package)) {
    return("")
  } 
  
  table <- citations[citations$name == package,]

  return(
    glue::glue_collapse(glue::glue_data(
      table,
      'ðŸ“ƒ {citation} <a href="https://doi.org/{doi}" target="_blank">https://doi.org/{doi}</a>'), 
      sep = "<br>")
  )
}

packages$citations <- NA

for (i in 1:nrow(packages)) {
  packages$citations[i] <- get_citations(
    packages$package[i],
    citations
    )
}

registry <- jsonlite::read_json("https://ropensci.github.io/roregistry/registry.json")
pkgs <- purrr::map_chr(registry$packages, "name")
registry <- registry$packages[pkgs %in% packages$package]

for (i in 1:length(registry)) {
  registry[[i]]$citations <- packages$citations[packages$package == registry[[i]]$name]
  
    registry[[i]]$data_source <- packages$data_source[packages$package == registry[[i]]$name]
    
  registry[[i]]$details <- gsub("\\\n","", registry[[i]]$details)
}

jsonlite::write_json(
  list(packages = registry),
  path = "registry.json",
  auto_unbox = TRUE,
  pretty = TRUE
  )
```

### Table of `r length(registry)` packages

The table below uses JS libraries including DataTable and jQuery.
If you have disabled JS from your browser, explore [the JSON feeding the table](registry.json).
For a full list of rOpenSci packages including their peer-review status, see our [Packages page](/packages) -- that uses a similar JS stack.

You can expand rows by clicking on the book emoji :closed_book:.
This will reveal a longer description of the package, as well as a list of scientific papers citing the packages.
Click on the book emoji :book: again to collapse the row.

There are `r length(registry)` packages in the table below.

<!--html_preserve-->

<table  class="display" style="width:100%" id="packagestable">

</table>
<script src="https://code.jquery.com/jquery-3.5.0.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.7/showdown.min.js" integrity="sha256-CKVcPmoyXVeFTOJvk7+k99gKxTMnKIGs9u8RKFQngVk=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/js/jquery.dataTables.min.js" integrity="sha256-t5ZQTZsbQi8NxszC10CseKjJ5QeMw5NINtOXQrESGSU=" crossorigin="anonymous"></script>
<script type="text/javascript" src="table.js"></script>
<!-- https://datatables.net/forums/discussion/comment/151719/#Comment_151719 -->
<!--/html_preserve-->

Cat ipsum dolor sit amet, kick up litter for man running from cops stops to pet cats, goes to jail, i shredded your linens for you kitty run to human with blood on mouth from frenzied attack on poor innocent mouse, don't i look cute?. I hate cucumber pls dont throw it at me intently sniff hand. Leave hair on owner's clothes bite the neighbor's bratty kid. And sometimes switches in french and say "miaou" just because well why not lick plastic bags. Cat ass trophy meowing chowing and wowing but i shredded your linens for you, so crash against wall but walk away like nothing happened. Do i like standing on litter cuz i sits when i have spaces, my cat buddies have no litter i live in luxury cat life purrrrrr or cough hairball on conveniently placed pants or kitty kitty swat at dog make meme, make cute face so cat milk copy park pee walk owner escape bored tired cage droppings sick vet vomit. Slap owner's face at 5am until human fills food dish spend six hours per day washing, but still have a crusty butthole. Ask for petting intently sniff hand, and gimme attention gimme attention gimme attention gimme attention gimme attention gimme attention just kidding i don't want it anymore meow bye so chase dog then run away. Have a lot of grump in yourself because you can't forget to be grumpy and not be like king grumpy cat let me in let me out let me in let me out let me in let me out who broke this door anyway the fat cat sat on the mat bat away with paws and have a lot of grump in yourself because you can't forget to be grumpy and not be like king grumpy cat furrier and even more furrier hairball. Jump launch to pounce upon little yarn mouse, bare fangs at toy run hide in litter box until treats are fed fooled again thinking the dog likes me but fall over dead (not really but gets sypathy). Kitty ipsum dolor sit amet, shed everywhere shed everywhere stretching attack your ankles chase the red dot, hairball run catnip eat the grass sniff massacre a bird in the living room and then look like the cutest and most innocent animal on the planet and sweet beast. Climb leg.

[^cat]: http://www.catipsum.com
